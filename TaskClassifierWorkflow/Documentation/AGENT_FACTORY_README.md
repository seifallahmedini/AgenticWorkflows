# Agent Factory Design Pattern

This implementation demonstrates the **Factory Design Pattern** for creating AI agents for workflow executors in the TaskClassifierWorkflow project.

## Overview

The Agent Factory pattern provides a centralized, flexible way to create AI agents for use in workflow executors. It abstracts the agent creation process, making it easy to configure, test, and maintain.

## Components

### 1. IAgentFactory Interface

Located in: `TaskClassifierWorkflow/IAgentFactory.cs`

The factory interface defines the contract for creating agents:

```csharp
public interface IAgentFactory
{
    AIAgent CreateAgent(string executorType, string instructions, string? name = null);
    AIAgent CreateAgentWithTools(string executorType, string instructions, IList<AITool> tools, string? name = null);
}
```

### 2. AgentFactory Implementation

Located in: `TaskClassifierWorkflow/AgentFactory.cs`

The concrete factory implementation with these features:
- **Dependency Injection**: Accepts any `IChatClient` (Azure OpenAI, OpenAI, etc.)
- **Agent Caching**: Optional caching to reuse agents and improve performance
- **Validation**: Input validation for all parameters
- **Extensibility**: Easy to extend with new agent creation methods

```csharp
IAgentFactory factory = new AgentFactory(chatClient, enableCaching: true);
```

### 3. AgentExecutor Wrapper

Located in: `TaskClassifierWorkflow/AgentExecutor.cs`

A generic executor that integrates AI agents into workflows:

```csharp
var executor = new AgentExecutor<string, string>(
    executorId: "MyExecutor",
    agent: agent,
    inputConverter: input => $"Process: {input}",
    outputConverter: response => ExtractText(response)
);
```

## Key Benefits

### 1. **Separation of Concerns**
- Agent creation logic is centralized in the factory
- Business logic remains in executors
- Clear separation between agent configuration and usage

### 2. **Flexibility**
- Easy to swap between different AI providers (Azure OpenAI, OpenAI, etc.)
- Different factories for different environments (dev, test, production)
- Support for different agent configurations

### 3. **Testability**
- Create mock factories for unit testing
- Test workflow logic without actual AI calls
- Easy to inject test dependencies

### 4. **Consistency**
- All agents created with consistent configuration
- Centralized error handling
- Standardized agent naming and setup

### 5. **Performance**
- Optional agent caching to reduce overhead
- Reuse agents across multiple executor instances
- Efficient resource management

## Usage Examples

### Basic Usage

```csharp
// 1. Create factory with your chat client
IAgentFactory factory = new AgentFactory(chatClient, enableCaching: true);

// 2. Create an agent
AIAgent classifierAgent = factory.CreateAgent(
    executorType: "TaskClassifier",
    instructions: "Classify tasks into categories",
    name: "ClassifierAgent"
);

// 3. Create workflow executor
var executor = new AgentExecutor<string, string>(
    executorId: "Classifier",
    agent: classifierAgent
);

// 4. Use in workflow
WorkflowBuilder builder = new(executor);
var workflow = builder.Build();
```

### Agent with Tools (Function Calling)

```csharp
var agent = factory.CreateAgentWithTools(
    executorType: "DataProcessor",
    instructions: "Process data using available tools",
    tools: new List<AITool>
    {
        AIFunctionFactory.Create(MyFunction)
    },
    name: "ProcessorAgent"
);
```

### Custom Input/Output Converters

```csharp
var executor = new AgentExecutor<TaskData, string>(
    executorId: "TaskProcessor",
    agent: agent,
    inputConverter: task => $"Title: {task.Title}\nDesc: {task.Description}",
    outputConverter: response => ExtractTextFromResponse(response)
);
```

### Multi-Agent Workflow

```csharp
// Create multiple agents using the factory
var agent1 = factory.CreateAgent("Step1", "First step instructions");
var agent2 = factory.CreateAgent("Step2", "Second step instructions");
var agent3 = factory.CreateAgent("Step3", "Third step instructions");

// Create executors
var exec1 = new AgentExecutor<string, string>("Exec1", agent1);
var exec2 = new AgentExecutor<string, string>("Exec2", agent2);
var exec3 = new AgentExecutor<string, string>("Exec3", agent3);

// Build workflow
WorkflowBuilder builder = new(exec1);
builder.AddEdge(exec1, exec2)
       .AddEdge(exec2, exec3)
       .WithOutputFrom(exec3);
var workflow = builder.Build();
```

## Configuration

### Azure OpenAI Setup

```csharp
using Azure.AI.OpenAI;
using Azure.Identity;

var chatClient = new AzureOpenAIClient(
    new Uri("https://<your-resource>.openai.azure.com"),
    new AzureCliCredential()
).GetChatClient("gpt-4o-mini");

IAgentFactory factory = new AgentFactory(chatClient);
```

### OpenAI Setup

```csharp
using OpenAI;

var chatClient = new OpenAIClient("<your-api-key>")
    .GetChatClient("gpt-4");

IAgentFactory factory = new AgentFactory(chatClient);
```

## Best Practices

### 1. **Use Interface for Flexibility**
Always depend on `IAgentFactory` interface, not the concrete implementation:

```csharp
// Good
IAgentFactory factory = new AgentFactory(chatClient);

// Avoid
AgentFactory factory = new AgentFactory(chatClient);
```

### 2. **Enable Caching for Production**
Enable caching when agents have the same configuration:

```csharp
IAgentFactory factory = new AgentFactory(chatClient, enableCaching: true);
```

### 3. **Provide Clear Instructions**
Give each agent clear, specific instructions:

```csharp
var agent = factory.CreateAgent(
    "Summarizer",
    "Summarize the input text in exactly one sentence, focusing on key points.",
    "TextSummarizer"
);
```

### 4. **Use Descriptive Names**
Use meaningful executor types and names:

```csharp
// Good
factory.CreateAgent("EmailClassifier", instructions, "EmailClassifierAgent");

// Avoid
factory.CreateAgent("Agent1", instructions);
```

### 5. **Implement Custom Factories for Testing**

```csharp
public class TestAgentFactory : IAgentFactory
{
    public AIAgent CreateAgent(string executorType, string instructions, string? name = null)
    {
        return new MockAgent(); // Return test doubles
    }
    // ...
}
```

## Architecture Diagram

```
???????????????????????????????????????????????????????????????
?                    Workflow Layer                           ?
?  ????????????????   ????????????????   ????????????????   ?
?  ? Executor 1   ????? Executor 2   ????? Executor 3   ?   ?
?  ????????????????   ????????????????   ????????????????   ?
???????????????????????????????????????????????????????????????
         ?                   ?                   ?
         ?                   ?                   ?
???????????????????????????????????????????????????????????????
?              AgentExecutor Wrapper Layer                     ?
?  ????????????????   ????????????????   ????????????????   ?
?  ? AgentExec 1  ?   ? AgentExec 2  ?   ? AgentExec 3  ?   ?
?  ????????????????   ????????????????   ????????????????   ?
???????????????????????????????????????????????????????????????
         ?                   ?                   ?
         ?                   ?                   ?
???????????????????????????????????????????????????????????????
?                    AI Agent Layer                           ?
?  ????????????????   ????????????????   ????????????????   ?
?  ?   AIAgent 1  ?   ?   AIAgent 2  ?   ?   AIAgent 3  ?   ?
?  ????????????????   ????????????????   ????????????????   ?
???????????????????????????????????????????????????????????????
                              ?
                              ?
???????????????????????????????????????????????????????????????
?                   Agent Factory                             ?
?              ????????????????????                           ?
?              ?  IAgentFactory   ?????????????????????       ?
?              ????????????????????                   ?       ?
?                       ?                             ?       ?
?              ????????????????????        ?????????????????? ?
?              ?  AgentFactory    ?        ? TestFactory    ? ?
?              ?  (Production)    ?        ? (Testing)      ? ?
?              ????????????????????        ?????????????????? ?
???????????????????????????????????????????????????????????????
                              ?
                              ?
???????????????????????????????????????????????????????????????
?                 Chat Client Layer                           ?
?         Azure OpenAI / OpenAI / Custom Client               ?
???????????????????????????????????????????????????????????????
```

## Testing

### Unit Testing with Mock Factory

```csharp
[Test]
public async Task TestWorkflowWithMockFactory()
{
    // Arrange
    IAgentFactory mockFactory = new MockAgentFactory();
    var agent = mockFactory.CreateAgent("Test", "Test instructions");
    var executor = new AgentExecutor<string, string>("Test", agent);
    
    // Act & Assert
    // Test your workflow logic without actual AI calls
}
```

## Extension Points

The factory pattern makes it easy to extend functionality:

1. **Custom Agent Types**: Add new `CreateXyzAgent()` methods
2. **Agent Caching Strategies**: Implement different caching mechanisms
3. **Configuration Providers**: Load agent configurations from files/databases
4. **Monitoring**: Add telemetry and logging to agent creation
5. **Agent Pooling**: Implement object pooling for better resource management

## Related Files

- `IAgentFactory.cs` - Factory interface
- `AgentFactory.cs` - Concrete factory implementation
- `AgentExecutor.cs` - Executor wrapper for agents
- `Program.cs` - Example usage
- `Examples/AgentFactoryExamples.cs` - Comprehensive examples

## License

This implementation is part of the TaskClassifierWorkflow project.
